{% extends "base.html" %}

{% block title %}–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ - ProThemesRU{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">üî® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–∞–π—Ç–æ–≤ ProThemesRU</h1>
            <p class="lead text-center">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–∞–π—Ç—ã —Å –ø–æ–º–æ—â—å—é –≥–æ—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤</p>
        </div>
    </div>

    <div class="row">
        <!-- –ü–∞–Ω–µ–ª—å –±–ª–æ–∫–æ–≤ -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì¶ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–ª–æ–∫–∏</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% for category, blocks in available_blocks.items() %}
                    <div class="mb-3">
                        <h6 class="text-muted">{{ category.replace('_', ' ').title() }}</h6>
                        {% for block_id, block_data in blocks.items() %}
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-primary w-100" 
                                    onclick="addBlockToConstructor('{{ block_id }}')">
                                {{ block_data.name }}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üé® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearConstructor()">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="savePage()">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="constructorArea" class="border rounded p-3" style="min-height: 400px;">
                        <div class="text-center text-muted py-5">
                            <h6>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–ª–æ–∫–∏ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫"</h6>
                            <p class="small">–ë–ª–æ–∫–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="previewArea">
                        <div class="text-center text-muted py-3">
                            <small>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h5>
                </div>
                <div class="card-body">
                    <div id="pageStructure">
                        <div class="text-center text-muted">
                            <small>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let constructorBlocks = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadPageStructure();
    updatePreview();
});

function addBlockToConstructor(blockId) {
    fetch('/api/constructor/add-block', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            block_id: blockId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            constructorBlocks = data.page_structure;
            updateConstructorArea();
            updatePageStructure();
            updatePreview();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª–æ–∫–∞');
    });
}

function updateConstructorArea() {
    const area = document.getElementById('constructorArea');
    if (constructorBlocks.length === 0) {
        area.innerHTML = `
            <div class="text-center text-muted py-5">
                <h6>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–ª–æ–∫–∏ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫"</h6>
                <p class="small">–ë–ª–æ–∫–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
            </div>
        `;
    } else {
        area.innerHTML = `
            <div class="text-center mb-3">
                <small class="text-muted">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç ${constructorBlocks.length} –±–ª–æ–∫–æ–≤</small>
            </div>
            <div class="d-flex flex-column gap-2">
                ${constructorBlocks.map((block, index) => `
                    <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${block.name}</strong>
                            <small class="text-muted d-block">${block.category}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeBlock(${index})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
}

function updatePageStructure() {
    const structure = document.getElementById('pageStructure');
    if (constructorBlocks.length === 0) {
        structure.innerHTML = `
            <div class="text-center text-muted">
                <small>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</small>
            </div>
        `;
    } else {
        structure.innerHTML = `
            <div class="row">
                ${constructorBlocks.map((block, index) => `
                    <div class="col-md-3 mb-2">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="card-title small">${index + 1}. ${block.name}</h6>
                                <p class="card-text small text-muted">${block.category}</p>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="moveBlock(${index}, ${index - 1})" ${index === 0 ? 'disabled' : ''}>
                                        ‚¨ÜÔ∏è
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="moveBlock(${index}, ${index + 1})" ${index === constructorBlocks.length - 1 ? 'disabled' : ''}>
                                        ‚¨áÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
}

function updatePreview() {
    fetch('/api/constructor/page-html')
    .then(response => response.json())
    .then(data => {
        if (data.html) {
            const preview = document.getElementById('previewArea');
            preview.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">HTML (${data.blocks_count} –±–ª–æ–∫–æ–≤):</small>
                </div>
                <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                    <pre class="small"><code>${data.html}</code></pre>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function clearConstructor() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä?')) {
        constructorBlocks = [];
        updateConstructorArea();
        updatePageStructure();
        updatePreview();
    }
}

function savePage() {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    alert('–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
}

function removeBlock(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) {
        constructorBlocks.splice(index, 1);
        updateConstructorArea();
        updatePageStructure();
        updatePreview();
    }
}

function moveBlock(fromIndex, toIndex) {
    if (toIndex >= 0 && toIndex < constructorBlocks.length) {
        const block = constructorBlocks.splice(fromIndex, 1)[0];
        constructorBlocks.splice(toIndex, 0, block);
        updateConstructorArea();
        updatePageStructure();
        updatePreview();
    }
}

function loadPageStructure() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    constructorBlocks = {{ page_structure|tojson }};
    updateConstructorArea();
    updatePageStructure();
}
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-1px);
}

#constructorArea {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
}

#constructorArea:hover {
    border-color: #007bff;
}

.btn-sm {
    font-size: 0.75rem;
}
</style>
{% endblock %} 